<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Level 3 - XSS Lab</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body {
      background-color: #0d0d0d;
      color: #00ffcc;
      font-family: 'Courier New', Courier, monospace;
      padding: 2rem;
    }
    .container {
      max-width: 750px;
      margin: auto;
      background: #1a1a1a;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 0 20px #00ffcc44;
    }
    .terminal-box {
      background: #111;
      color: #33ff33;
      padding: 1rem;
      font-family: monospace;
      border-radius: 0.5rem;
      margin-top: 1rem;
      white-space: pre-wrap;
    }
    .hint {
      font-size: 0.9rem;
      color: #00cc88;
      margin-bottom: 10px;
    }
    #nextBtn {
      display: none;
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center">üíâ Level 3 - XSS Lab (Reflected + Stored)</h2>
    <p class="hint">Hint: Base64-encoded payloads, DOM sinks, and stored input ‚Äì everything's injectable if you try.</p>

    <form id="commentForm">
      <input type="text" id="comment" class="form-control" placeholder="Base64-encoded comment (e.g. PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg==)">
      <button type="submit" class="btn btn-outline-info w-100 mt-2">Post Comment</button>
    </form>

    <div class="terminal-box">
      <b>Stored Comments:</b>
      <div id="commentLog"></div>
    </div>

    <div class="terminal-box mt-4">
      <b>Reflected Input:</b>
      <div id="reflected"></div>
    </div>

    <a id="nextBtn" href="level4.html" class="btn btn-success w-100">‚û°Ô∏è Proceed to Level 4</a>
  </div>

  <script>
    const flagsUnlocked = new Set(JSON.parse(localStorage.getItem("ctf-flags") || "[]"));
    const reflectedParam = new URLSearchParams(window.location.search).get("vuln");
    const reflectedBox = document.getElementById("reflected");

    function storeFlag(flag) {
      if (!flagsUnlocked.has(flag)) {
        flagsUnlocked.add(flag);
        localStorage.setItem("ctf-flags", JSON.stringify([...flagsUnlocked]));
      }
      document.getElementById("nextBtn").style.display = "block";
    }

    if (reflectedParam) {
      try {
        const decoded = atob(reflectedParam);
        reflectedBox.innerHTML = decoded;
        if (decoded.includes("<script") || decoded.includes("onerror")) {
          alert("üí• Reflected XSS Triggered! Flag: CTF{xss_reflect_warrior}");
          storeFlag("CTF{xss_reflect_warrior}");
        }
      } catch {
        reflectedBox.textContent = "Invalid base64 input.";
      }
    } else {
      reflectedBox.textContent = "(no input reflected)";
    }

    const form = document.getElementById("commentForm");
    const logBox = document.getElementById("commentLog");
    const storedComments = JSON.parse(localStorage.getItem("xss-comments") || "[]");

    function renderComments() {
      logBox.innerHTML = "";
      storedComments.forEach((encoded, i) => {
        try {
          const decoded = atob(encoded);
          const div = document.createElement("div");
          div.innerHTML = decoded;
          logBox.appendChild(div);

          if (decoded.includes("<script") || decoded.includes("onerror")) {
            alert("üî• Stored XSS Triggered! Flag: CTF{stored_xss_victory}");
            storeFlag("CTF{stored_xss_victory}");
          }
        } catch {
          logBox.innerHTML += `<div>Invalid base64</div>`;
        }
      });
    }

    renderComments();

    form.onsubmit = (e) => {
      e.preventDefault();
      const val = document.getElementById("comment").value.trim();
      if (val) {
        storedComments.push(val);
        localStorage.setItem("xss-comments", JSON.stringify(storedComments));
        renderComments();
      }
    };
  </script>
</body>
</html>
